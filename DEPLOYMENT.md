# Railway Deployment Guide - Inventory Release Management App

## Prerequisites

- [x] Railway account created and CLI installed
- [x] GitHub account with repository access
- [x] Cloudflare R2 account for PDF storage
- [x] SendGrid API key for email notifications

---

## Step 1: Cloudflare R2 Setup

1. **Create R2 Bucket**
   ```bash
   # Log in to Cloudflare dashboard
   # Navigate to R2 Object Storage
   # Click "Create Bucket"
   # Bucket name: inventory-release-pdfs
   # Region: Auto
   # Public Access: Disabled (use signed URLs) or Enabled (for public URLs)
   ```

2. **Create R2 API Token**
   ```bash
   # In Cloudflare dashboard > R2
   # Click "Manage R2 API Tokens"
   # Click "Create API Token"
   # Name: inventory-release-app-production
   # Permissions: Object Read & Write
   # Copy Access Key ID and Secret Access Key
   ```

3. **Get R2 Endpoint**
   ```
   Format: https://<account-id>.r2.cloudflarestorage.com
   Find your account ID in the R2 dashboard URL
   ```

---

## Step 2: GitHub Repository Setup

1. **Initialize Git (if not already done)**
   ```bash
   cd /Users/nicholasdeblasio/inventory-release-app
   git init
   git add .
   git commit -m "Initial commit: Inventory Release Management App

   - Next.js 15.5.6 with React 19
   - Prisma ORM with PostgreSQL support
   - JWT authentication
   - PDF generation (packing slips, box labels, invoices)
   - SendGrid email integration
   - Cloudflare R2 cloud storage for PDFs

   ðŸ¤– Generated with Claude Code (https://claude.com/claude-code)

   Co-Authored-By: Claude <noreply@anthropic.com>"
   ```

2. **Create GitHub Repository**
   ```bash
   # Option A: Using GitHub CLI
   gh auth login
   gh repo create inventory-release-app --private --source=. --remote=origin
   gh repo view --web

   # Option B: Using GitHub Web UI
   # Go to https://github.com/new
   # Repository name: inventory-release-app
   # Visibility: Private
   # Do NOT initialize with README, .gitignore, or license
   # Click "Create repository"
   ```

3. **Push to GitHub**
   ```bash
   git branch -M main
   git remote add origin https://github.com/YOUR_USERNAME/inventory-release-app.git
   git push -u origin main
   ```

---

## Step 3: Railway Project Setup

1. **Create Railway Project**
   ```bash
   # Option A: Using Railway CLI
   railway login
   railway init
   # Follow prompts to link GitHub repository

   # Option B: Using Railway Dashboard
   # Go to https://railway.app/new
   # Click "Deploy from GitHub repo"
   # Select your repository
   # Click "Deploy Now"
   ```

2. **Add PostgreSQL Database**
   ```bash
   # Using Railway CLI
   railway add --database postgresql

   # Using Railway Dashboard
   # In your project, click "+ New"
   # Select "Database" > "PostgreSQL"
   # Railway will auto-generate DATABASE_URL variable
   ```

---

## Step 4: Environment Variables Configuration

### Required Environment Variables

Copy these variables to Railway (Dashboard > Variables tab):

```bash
# Database (auto-generated by Railway PostgreSQL service)
DATABASE_URL=postgresql://...  # Auto-populated

# JWT Authentication
JWT_SECRET=e+BaMLjRcaCaKYcqASx60X0unkDqem1FKhhKOLitC7Y=

# Application URL (update after first deployment)
NEXT_PUBLIC_APP_URL=https://your-app.up.railway.app

# SendGrid Email
SENDGRID_API_KEY=your-sendgrid-api-key-here
EMAIL_FROM=nick@jdgraphic.com
EMAIL_FROM_NAME=EPG Release
EMAIL_TO=nick@jdgraphic.com
EMAIL_CC=kicuss@eprintgroup.com,abates@eprintgroup.com,mwelker@eprintgroup.com

# Cloudflare R2 Storage
R2_ENDPOINT=https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com
R2_ACCESS_KEY_ID=your-r2-access-key-id
R2_SECRET_ACCESS_KEY=your-r2-secret-access-key
R2_BUCKET_NAME=inventory-release-pdfs
R2_PUBLIC_URL=  # Optional: leave empty or add custom domain

# Node Environment (auto-set by Railway)
NODE_ENV=production
```

### Setting Variables via Railway CLI

```bash
# Set individual variables
railway variables set JWT_SECRET="e+BaMLjRcaCaKYcqASx60X0unkDqem1FKhhKOLitC7Y="
railway variables set SENDGRID_API_KEY="your-key-here"
railway variables set R2_ENDPOINT="https://your-account-id.r2.cloudflarestorage.com"
railway variables set R2_ACCESS_KEY_ID="your-access-key"
railway variables set R2_SECRET_ACCESS_KEY="your-secret-key"
railway variables set R2_BUCKET_NAME="inventory-release-pdfs"
railway variables set EMAIL_FROM="nick@jdgraphic.com"
railway variables set EMAIL_FROM_NAME="EPG Release"
railway variables set EMAIL_TO="nick@jdgraphic.com"
railway variables set EMAIL_CC="kicuss@eprintgroup.com,abates@eprintgroup.com,mwelker@eprintgroup.com"
```

---

## Step 5: Initial Deployment

1. **Trigger Deployment**
   - Railway will auto-deploy on git push to main branch
   - Monitor deployment logs in Railway dashboard
   - Build should complete in ~2-3 minutes

2. **Monitor Build Logs**
   ```bash
   # Using Railway CLI
   railway logs

   # Check for any errors related to:
   # - canvas package compilation (native dependencies)
   # - Prisma client generation
   # - Next.js build
   ```

3. **Get Deployment URL**
   ```bash
   railway domain
   # Copy the URL (e.g., https://inventory-release-app.up.railway.app)
   ```

4. **Update NEXT_PUBLIC_APP_URL**
   ```bash
   railway variables set NEXT_PUBLIC_APP_URL="https://your-actual-url.up.railway.app"
   # This will trigger a redeployment
   ```

---

## Step 6: Database Migration & Seeding

1. **Run Prisma Database Push**
   ```bash
   # Using Railway CLI
   railway run npx prisma db push

   # Verify schema created
   railway run npx prisma db pull
   ```

2. **Seed Database**
   ```bash
   # Seed initial data (2 parts, 4 locations, 2 users)
   railway run npm run db:seed
   ```

3. **Verify Database Content**
   ```bash
   # Connect to PostgreSQL
   railway connect postgresql

   # Check tables
   \dt

   # Check users
   SELECT email, role FROM "User";

   # Check parts
   SELECT "partNumber", description FROM "Part";

   # Check shipping locations
   SELECT name, city, state FROM "ShippingLocation";

   # Exit
   \q
   ```

---

## Step 7: Post-Deployment Testing

### Test Login
1. Navigate to your Railway URL
2. Login with:
   - **Admin**: `admin@jdgraphic.com` / `admin123`
   - **Customer**: `customer@eprintgroup.com` / `customer123`

### Test Release Creation
1. Login as customer
2. Navigate to "Create Release"
3. Fill out the 3-step wizard:
   - Step 1: Select part and shipping location
   - Step 2: Enter order details
   - Step 3: Generate documents
4. Verify:
   - PDFs are generated and uploaded to R2
   - Email notifications sent to 4 recipients
   - Release appears in history

### Test PDF Generation
1. Create a test release
2. Check email for PDF attachments
3. Verify PDFs open correctly
4. Check R2 bucket for uploaded files

### Test Admin Features
1. Login as admin
2. Add production run
3. View inventory levels
4. Verify inventory calculations

---

## Step 8: Monitoring & Maintenance

### Monitor Application Health
```bash
# View real-time logs
railway logs --follow

# Check deployment status
railway status

# View metrics
railway metrics
```

### Common Issues & Solutions

**Issue: Canvas package fails to build**
```bash
# Railway's Nixpacks should auto-detect canvas dependencies
# If it fails, add to railway.toml:
[build]
nixPkgs = ["cairo", "pango", "libjpeg", "giflib", "librsvg"]
```

**Issue: Prisma client not generated**
```bash
# Ensure buildCommand includes prisma generate
railway run npx prisma generate
```

**Issue: R2 upload fails**
```bash
# Check R2 environment variables
railway variables
# Verify R2 API token permissions in Cloudflare dashboard
```

**Issue: Emails not sending**
```bash
# Verify SendGrid API key
# Check SendGrid dashboard for send activity
# Review railway logs for email errors
```

### Database Backups
```bash
# Manual backup
railway run pg_dump $DATABASE_URL > backup-$(date +%Y%m%d).sql

# Railway provides automatic daily backups (7-day retention)
# Access via Railway dashboard > PostgreSQL service > Backups tab
```

### Rolling Back Deployments
```bash
# View deployment history
railway deployments

# Rollback to previous deployment
railway rollback <deployment-id>
```

---

## Step 9: Custom Domain (Optional)

1. **Add Custom Domain**
   ```bash
   railway domain add yourdomain.com
   ```

2. **Configure DNS**
   - Add CNAME record pointing to Railway domain
   - Railway will auto-provision SSL certificate

3. **Update Environment Variables**
   ```bash
   railway variables set NEXT_PUBLIC_APP_URL="https://yourdomain.com"
   ```

---

## Cost Monitoring

### Expected Monthly Costs (Railway Hobby Plan)
- PostgreSQL database: ~$0.50-2/month
- Web service: ~$2-5/month
- **Total**: ~$5-10/month

### R2 Storage Costs
- Storage: $0.015/GB/month
- Egress: Free (Class A operations: $4.50/million)
- Estimated: <$1/month for typical usage

### SendGrid Costs
- Free tier: 100 emails/day
- If exceeded: $19.95/month for 40K emails

**Total estimated cost: $6-15/month**

---

## Security Checklist

- [x] JWT_SECRET is cryptographically secure
- [x] Database URL not committed to git
- [x] R2 API keys stored as environment variables
- [x] SendGrid API key secured
- [x] HTTPS enabled (automatic with Railway)
- [x] .env file in .gitignore
- [ ] Enable rate limiting on API routes (future enhancement)
- [ ] Implement CORS configuration (if needed)
- [ ] Regular dependency updates (`npm audit`)

---

## Support & Troubleshooting

### Railway Support
- Documentation: https://docs.railway.app
- Community: https://discord.gg/railway
- Status: https://status.railway.app

### Cloudflare R2 Support
- Documentation: https://developers.cloudflare.com/r2/
- Community: https://community.cloudflare.com

### Next.js Support
- Documentation: https://nextjs.org/docs
- GitHub: https://github.com/vercel/next.js

---

## Deployment Complete! ðŸŽ‰

Your Inventory Release Management Application is now live on Railway with:
- âœ… PostgreSQL database
- âœ… Cloudflare R2 PDF storage
- âœ… SendGrid email notifications
- âœ… Automatic HTTPS
- âœ… Continuous deployment from GitHub

**Next Steps:**
1. Share the Railway URL with stakeholders
2. Test all features thoroughly
3. Monitor logs for any errors
4. Set up database backups schedule
5. Configure custom domain (optional)
